{% extends 'base.html' %}
{% load static %}

{% block title %}Calendar - Bill Payment Reminder{% endblock %}

{% block extra_head %}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
<style>
    .fc {
        background: var(--bg-card, #fff);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .fc-event {
        cursor: pointer;
        border-radius: 6px;
        font-size: 0.85rem;
        padding: 2px 6px;
    }

    .fc-toolbar-title {
        color: var(--text-primary, #0f172a);
    }

    .fc-button-primary {
        background: var(--primary-color, #2563eb) !important;
        border-color: var(--primary-color, #2563eb) !important;
    }

    .fc-button-primary:hover {
        background: var(--primary-dark, #1e40af) !important;
    }

    .fc-daygrid-day-number {
        color: var(--text-primary, #0f172a);
    }

    .fc-col-header-cell-cushion {
        color: var(--text-primary, #0f172a);
    }

    [data-theme="dark"] .fc-day {
        background: var(--bg-card, #1e293b);
    }

    [data-theme="dark"] .fc-day-today {
        background: rgba(59, 130, 246, 0.15) !important;
    }

    .calendar-legend {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
    }

    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 4px;
    }

    /* Bill details modal */
    .bill-modal-content {
        padding: 20px;
    }

    .bill-modal-content h5 {
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-calendar3 text-primary"></i> Bill Calendar</h1>
        <a href="{% url 'bill-create' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Add Bill
        </a>
    </div>

    <!-- Legend -->
    <div class="calendar-legend">
        <div class="legend-item">
            <span class="legend-color" style="background: #ef4444;"></span>
            <span>Overdue</span>
        </div>
        <div class="legend-item">
            <span class="legend-color" style="background: #f59e0b;"></span>
            <span>Due Soon</span>
        </div>
        <div class="legend-item">
            <span class="legend-color" style="background: #2563eb;"></span>
            <span>Pending</span>
        </div>
        <div class="legend-item">
            <span class="legend-color" style="background: #10b981;"></span>
            <span>Paid</span>
        </div>
        <div class="legend-item">
            <span class="legend-color" style="background: #fef3c7; border: 1px solid #f59e0b;"></span>
            <span>Recurring (Future)</span>
        </div>
    </div>

    <!-- Calendar Container -->
    <div id="calendar"></div>
</div>

<!-- Bill Details Modal -->
<div class="modal fade" id="billModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="billModalTitle">Bill Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bill-modal-content">
                <p><strong>Amount:</strong> <span id="billAmount"></span></p>
                <p><strong>Category:</strong> <span id="billCategory"></span></p>
                <p><strong>Status:</strong> <span id="billStatus"></span></p>
                <p><strong>Recurring:</strong> <span id="billRecurring"></span></p>
            </div>
            <div class="modal-footer">
                <a id="billEditLink" href="#" class="btn btn-outline-primary">
                    <i class="bi bi-pencil"></i> Edit
                </a>
                <a id="billPayLink" href="#" class="btn btn-success">
                    <i class="bi bi-check-circle"></i> Mark Paid
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Add Bill on Date Modal -->
<div class="modal fade" id="addBillModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle"></i> Add Bill for <span id="selectedDate"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <p>Would you like to add a new bill for this date?</p>
                <a id="addBillLink" href="{% url 'bill-create' %}" class="btn btn-primary btn-lg">
                    <i class="bi bi-plus-circle"></i> Create Bill
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');
        const billModal = new bootstrap.Modal(document.getElementById('billModal'));
        const addBillModal = new bootstrap.Modal(document.getElementById('addBillModal'));

        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,dayGridWeek,listMonth'
            },

            events: {
                url: '{% url "calendar_events" %}',
                failure: function () {
                    console.error('Error loading calendar events');
                }
            },

            // Click on date to add new bill
            dateClick: function (info) {
                document.getElementById('selectedDate').textContent = info.dateStr;
                // Pass date to create form via URL param
                document.getElementById('addBillLink').href =
                    '{% url "bill-create" %}?date=' + info.dateStr;
                addBillModal.show();
            },

            // Click on event to view bill details
            eventClick: function (info) {
                const event = info.event;
                const props = event.extendedProps;
                const eventId = String(event.id);

                // Check if this is a future virtual event
                const isFutureEvent = eventId.startsWith('future_') || props.is_future;

                document.getElementById('billModalTitle').textContent = event.title.split(' - ')[0].replace('ðŸ“… ', '');
                document.getElementById('billAmount').textContent = 'â‚±' + props.amount;
                document.getElementById('billCategory').textContent = props.category;

                if (isFutureEvent) {
                    // Future event - show "Upcoming" status
                    document.getElementById('billStatus').innerHTML = '<span class="badge bg-info">Upcoming (Recurring)</span>';
                    document.getElementById('billRecurring').textContent = 'Yes';

                    // Use original bill ID for editing
                    const originalBillId = props.original_bill_id;
                    if (originalBillId) {
                        document.getElementById('billEditLink').href = '/bills/' + originalBillId + '/edit/';
                        document.getElementById('billEditLink').innerHTML = '<i class="bi bi-pencil"></i> Edit Recurring Bill';
                        document.getElementById('billEditLink').style.display = 'inline-block';
                    } else {
                        document.getElementById('billEditLink').style.display = 'none';
                    }
                    // Hide pay button for future events (bill doesn't exist yet)
                    document.getElementById('billPayLink').style.display = 'none';
                } else {
                    // Real bill - show normal status
                    document.getElementById('billStatus').textContent = props.status.charAt(0).toUpperCase() + props.status.slice(1);
                    document.getElementById('billRecurring').textContent = props.is_recurring ? 'Yes' : 'No';

                    document.getElementById('billEditLink').href = '/bills/' + eventId + '/edit/';
                    document.getElementById('billEditLink').innerHTML = '<i class="bi bi-pencil"></i> Edit';
                    document.getElementById('billEditLink').style.display = 'inline-block';
                    document.getElementById('billPayLink').href = '/bills/' + eventId + '/pay/';

                    // Hide pay button if already paid
                    if (props.status === 'paid') {
                        document.getElementById('billPayLink').style.display = 'none';
                    } else {
                        document.getElementById('billPayLink').style.display = 'inline-block';
                    }
                }

                billModal.show();
            },

            // Responsive height
            height: 'auto',

            // Show week numbers
            weekNumbers: true,

            // Highlight today
            nowIndicator: true,
        });

        calendar.render();
    });
</script>
{% endblock %}