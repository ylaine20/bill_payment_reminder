{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Welcome Section -->
    <div class="mb-4">
        <h2>Welcome, {{ request.user.first_name|default:request.user.username }}!</h2>
        <p class="text-muted mb-0">Here's an overview of your bills</p>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-4 mb-4">
        <!-- Total Bills -->
        <div class="col-md-3">
            <div class="card border-primary shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1">Total Bills</p>
                            <h3 class="mb-0">{{ total_bills }}</h3>
                        </div>
                        <div class="text-primary">
                            <i class="bi bi-receipt fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Bills -->
        <div class="col-md-3">
            <div class="card border-warning shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1">Pending Bills</p>
                            <h3 class="mb-0 text-warning">{{ total_pending }}</h3>
                            <small class="text-muted">Awaiting payment</small>
                        </div>
                        <div class="text-warning">
                            <i class="bi bi-clock-history fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Paid This Month -->
        <div class="col-md-3">
            <div class="card border-success shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1">Paid This Month</p>
                            <h3 class="mb-0 text-success">{{ paid_this_month }}</h3>
                            <small class="text-muted">Completed payments</small>
                        </div>
                        <div class="text-success">
                            <i class="bi bi-check-circle fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overdue Bills -->
        <div class="col-md-3">
            <div class="card border-danger shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1">Overdue Bills</p>
                            <h3 class="mb-0 text-danger">{{ overdue_count }}</h3>
                            <small class="text-danger">Need attention</small>
                        </div>
                        <div class="text-danger">
                            <i class="bi bi-exclamation-triangle fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Upcoming Bills -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-calendar-event"></i> Upcoming Bills</h5>
                    <span class="badge bg-primary">Next 7 Days</span>
                </div>
                <div class="card-body">
                    {% if upcoming_bills %}
                    <div class="list-group list-group-flush">
                        {% for bill in upcoming_bills %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">{{ bill.name }}</h6>
                                    <small class="text-muted">
                                        Due: {{ bill.due_date|date:"M d, Y" }}
                                        {% if bill.is_overdue %}
                                        <span class="badge bg-danger ms-2">Overdue</span>
                                        {% elif bill.is_due_soon %}
                                        <span class="badge bg-warning ms-2">Due Soon</span>
                                        {% endif %}
                                    </small>
                                </div>
                                <div class="text-end">
                                    <h5 class="mb-0">â‚±{{ bill.amount }}</h5>
                                    <a href="{% url 'bill-pay' bill.pk %}" class="btn btn-sm btn-success mt-1">
                                        <i class="bi bi-check-circle"></i> Pay
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-calendar-check fs-1"></i>
                        <p class="mb-0 mt-2">No upcoming bills in the next 7 days</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Mini Calendar -->
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-calendar3"></i> Bill Calendar</h5>
                    <a href="{% url 'calendar' %}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-arrows-fullscreen"></i>
                    </a>
                </div>
                <div class="card-body p-2">
                    <div id="miniCalendar"></div>
                    <!-- Legend -->
                    <div class="d-flex justify-content-center gap-3 mt-2 small">
                        <span><span
                                style="display:inline-block;width:10px;height:10px;background:#ef4444;border-radius:2px;"></span>
                            Overdue</span>
                        <span><span
                                style="display:inline-block;width:10px;height:10px;background:#f59e0b;border-radius:2px;"></span>
                            Due Soon</span>
                        <span><span
                                style="display:inline-block;width:10px;height:10px;background:#10b981;border-radius:2px;"></span>
                            Paid</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
<style>
    #miniCalendar {
        font-size: 0.8rem;
    }

    #miniCalendar .fc-toolbar-title {
        font-size: 1rem;
    }

    #miniCalendar .fc-event {
        font-size: 0.7rem;
        padding: 1px 3px;
        border-radius: 3px;
    }

    #miniCalendar .fc-daygrid-day-number {
        font-size: 0.8rem;
    }

    #miniCalendar .fc-col-header-cell-cushion {
        font-size: 0.75rem;
    }

    [data-theme="dark"] #miniCalendar .fc-daygrid-day-number,
    [data-theme="dark"] #miniCalendar .fc-col-header-cell-cushion {
        color: var(--text-primary);
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('miniCalendar');

        if (calendarEl) {
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev',
                    center: 'title',
                    right: 'next'
                },
                height: 320,
                events: {
                    url: '{% url "calendar_events" %}',
                    failure: function () {
                        console.error('Error loading calendar events');
                    }
                },
                eventClick: function (info) {
                    const eventId = String(info.event.id);
                    const props = info.event.extendedProps;

                    // Check if this is a future virtual event
                    if (eventId.startsWith('future_') || props.is_future) {
                        // For future events, navigate to the original bill's detail page
                        if (props.original_bill_id) {
                            window.location.href = '/bills/' + props.original_bill_id + '/';
                        } else {
                            window.location.href = '{% url "calendar" %}';
                        }
                    } else {
                        // Navigate to bill detail on click
                        window.location.href = '/bills/' + eventId + '/';
                    }
                },
                dateClick: function (info) {
                    // Navigate to add bill with date
                    window.location.href = '{% url "bill-create" %}?date=' + info.dateStr;
                },
                eventDidMount: function (info) {
                    // Add tooltip
                    info.el.title = info.event.title;
                }
            });

            calendar.render();
        }
    });

    // Toggle Budget Form visibility
    function toggleBudgetForm() {
        var formSection = document.getElementById('budgetFormSection');
        if (formSection.style.display === 'none') {
            formSection.style.display = 'block';
        } else {
            formSection.style.display = 'none';
        }
    }

    // Make function globally accessible
    window.toggleBudgetForm = toggleBudgetForm;
</script>
{% endblock %}